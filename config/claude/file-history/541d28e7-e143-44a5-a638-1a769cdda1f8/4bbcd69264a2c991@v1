# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

- **Dev server**: `php artisan serve`
- **Tests**: `php artisan test` (all), `php artisan test --filter=TestClassName` (specific)
- **Lint/Format**: `./vendor/bin/pint` (Laravel Pint, PSR-12)
- **Clear cache**: `php artisan cache:clear && php artisan config:clear`
- **Migrations**: `php artisan migrate`, `php artisan migrate:rollback`
- **API docs**: `php artisan l5-swagger:generate` (accessible at `/api/documentation`)
- **Interactive shell**: `php artisan tinker`

## Architecture Overview

This is a **Laravel 10 REST API** for a multi-tenant document management platform (MyDocumentium). Key aspects:

### Multi-Tenancy
- All data isolated by `client_id` - every query must respect client context
- Superadmins can switch clients via `SuperAdminClientUUID` header
- Storage quotas tracked per client (`ClientsStorage` model)

### Authentication Flow
1. POST `/auth/login` returns JWT token
2. All requests use `Authorization: Bearer {token}` header
3. `JWTSession` middleware validates token and loads user/client into session
4. Sessions tracked in database (tokens must exist in DB)

### Permission System (3 levels)
1. **User → Entity → Permission**: Direct user permissions (e.g., `folders.create`)
2. **Group → Entity → Permission**: Role-based permissions via groups
3. **User → Folder → Permission**: Folder-level access control

Key methods: `User::isAbleTo('entity.action')`, `User::canViewAllFolders()`

### Key Middleware
- `JWTSession` - Token validation, user/client session loading
- `HasAccess:entity.action` - Permission checking (e.g., `hasAccess:folders.create`)
- `HasGroup:groupCodename` - Group-based access (e.g., `hasGroup:superadmin`)

### File Storage
- AWS S3 primary storage with multipart upload support for large files
- Temporary encrypted links for sharing (`DocumentTemporaryLinksHelper`)
- Document expiration with automatic cleanup via cron

### Main Routes Structure
All protected routes under `/api/v1/*` prefix with JWT middleware. Resources follow RESTful patterns:
- `/folders`, `/documents`, `/files` - File management
- `/plantilles` - Document templates/forms
- `/users`, `/groups`, `/clients` - User management
- `/permissions`, `/folder-tags`, `/file-tags` - Access control

Public endpoints: `/auth/login`, `/public-plantilles/{uuid}`, `/shared-documents/{uuid}`

## Code Style

- **PHP**: PSR-12 + Laravel conventions
- **Naming**: PascalCase (classes), camelCase (methods/variables), snake_case (DB columns)
- **Type hints**: Required for parameters and return types (PHP 8.1+)
- **Imports**: Group by type (Facades → App → Models → Services), alphabetical within groups
- **Controllers**: Extend BaseController, use `Controller::defaultResponse()` and `Controller::prepareResponse()`
- **Models**: Use `$fillable`, Eloquent relationships, `prepareFrontendInfo()` for API serialization
- **Helpers**: Static methods in `app/Helpers/` with single responsibility
- **Validation**: `Validator::make()` with custom message arrays
- **API docs**: OpenAPI annotations on controller methods

### Response Format
```php
return Controller::prepareResponse([
    'success' => boolean,
    'data' => $data,
    'errors' => [],
    'message' => 'translation.key',
    'actions' => ['logout' => boolean]
]);
```

## Key Files Reference

- **Routes**: `routes/web.php` (334 lines - all API routes defined here)
- **Auth middleware**: `app/Http/Middleware/JWTSession.php`, `HasAccess.php`
- **Main controllers**: `DocumentController`, `FolderController`, `PlantillaController`, `UserController`
- **Helpers**: `app/Helpers/FolderHelper.php`, `app/Helpers/Documents/DocumentHelper.php`
- **S3 operations**: `app/Services/S3ClientService.php`

## Database Notes

- Use `SoftDeletes` trait - check with `->onlyTrashed()`, `->withTrashed()`
- Most tables use UUID primary keys
- Client isolation enforced at query level
