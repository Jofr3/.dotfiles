SELECT
e.valoracio,
    e.nif,
    e.Nom_Empresa,
    e.Nick_Name,
    colaboradors.nick_colaboradors,
    estat_colaboradors,
    usersnif.user_consultor_ateinsa,
    usersnif.user_gestor_ateinsa,
    usersnif.user_admin,
    usersnif.user_admin_gestores,
    usersnif.user_promo,
    inversionsAny.sumInv,
    dataVisita,
    numOpo,
    sumaOpo,
    dataComentari,
    comentari
FROM empreses e
INNER JOIN (
    SELECT
        cev.nif,
        STRING_AGG(ce.nick_colaborador, ', ') WITHIN GROUP (ORDER BY ce.idtipus) AS nick_colaboradors,
        STRING_AGG(cev.colaborador_estat_id, ', ') AS estat_colaboradors
    FROM colaboradors_externs_vinculats cev
    INNER JOIN colaboradors_externs ce
        ON ce.idtipus = cev.colext_id
        AND ce.idcol_extern = cev.subcolext_id
    WHERE
        cev.data_ini <= GETDATE()
        AND (cev.data_fi IS NULL OR cev.data_fi >= GETDATE())
        AND cev.deleted_at IS NULL 
        /*FILTRE ESTAT */
        and cev.colaborador_estat_id not in (28,30,32,34,60,68,84,86)
        /* FILTRE COLABORADOR */
    GROUP BY cev.nif
) colaboradors ON colaboradors.nif = e.nif
INNER JOIN (
    SELECT
        users.nif,
        STRING_AGG(
            CASE WHEN users.nivell = 4 THEN users.nick_usuari END,
            ', '
        ) WITHIN GROUP (ORDER BY users.nick_usuari) AS user_consultor_ateinsa,
        STRING_AGG(
            CASE WHEN users.nivell = 5 THEN users.nick_usuari END,
            ', '
        ) WITHIN GROUP (ORDER BY users.nick_usuari) AS user_gestor_ateinsa,
        STRING_AGG(
            CASE WHEN users.nivell = 7 THEN users.nick_usuari END,
            ', '
        ) WITHIN GROUP (ORDER BY users.nick_usuari) AS user_admin,
        STRING_AGG(
            CASE WHEN users.nivell = 9 THEN users.nick_usuari END,
            ', '
        ) WITHIN GROUP (ORDER BY users.nick_usuari) AS user_admin_gestores,
        STRING_AGG(
            CASE WHEN users.nivell = 14 THEN users.nick_usuari END,
            ', '
        ) WITHIN GROUP (ORDER BY users.nick_usuari) AS user_promo
    FROM (
        SELECT
            uwce.nif,
            uw.nivell,
            uw.nick_usuari
        FROM usuaris_web_colaboradors_empresa uwce
        INNER JOIN usuaris_web uw
            ON uw.id_usuari = uwce.usuari_id
        INNER JOIN usuaris_web_tipus uwt
            ON uw.nivell = uwt.id_tipus_usuari_web
        INNER JOIN colaboradors_externs_vinculats cev
            ON cev.id = uwce.colext_vinc_id
            AND cev.deleted_at IS NULL
            AND cev.data_ini <= GETDATE()
            AND (cev.data_fi IS NULL OR cev.data_fi >= GETDATE())
        WHERE
            uwce.deleted_at IS NULL
            AND uwce.data_ini <= GETDATE()
            AND (uwce.data_fi IS NULL OR uwce.data_fi >= GETDATE())
            /* FILTRE USUARIS */
        GROUP BY
            uwce.nif,
            uw.nivell,
            uw.nick_usuari
    ) AS users
    GROUP BY users.nif
) AS usersnif ON usersnif.nif = e.nif

 left join (select nif, sum(inversio) as sumInv from projectes_promocio 
where year(data_ini)=year(GETDATE()) and estat<>0
group by nif) as inversionsAny on inversionsAny.nif= e.nif 

left join (select nif, CAST(MAX(data_visita) AS date)  as dataVisita from empreses_visites 
group by nif) as visites on visites.nif= e.nif 

left join (SELECT pro.nif, count(pro.id_oportunitat) as numOpo, sum(pro.oportunitat) as sumaOpo
FROM projectes_oportunitats pro 
LEFT JOIN pre_projectes pp ON pp.idoportunitat = pro.id_oportunitat
where pp.nif_empresa is null
GROUP BY pro.nif) as oportunitats on oportunitats.nif = e.nif

LEFT JOIN (
    SELECT
        nif,
        CAST(data_comentari AS date) AS dataComentari,
        comentari     AS comentari
    FROM (
        SELECT
            CAST(nif AS varchar(20)) COLLATE latin1_general_ci_as AS nif,
            data_comentari,
            comentari,
            ROW_NUMBER() OVER (
                PARTITION BY CAST(nif AS varchar(20)) COLLATE latin1_general_ci_as
                ORDER BY data_comentari DESC
            ) AS rn
        FROM vista_comunicacions_empresa
        WHERE nif IS NOT NULL and id_tipus_comment<>12
    ) x
    WHERE rn = 1
) AS ultimComentari ON ultimComentari.nif = e.nif
