select e.nif, nom_empresa, Nick_Name, nick_colaboradors,
usersnif.* 
from empreses e
inner join (SELECT 
    cev.nif,
    STRING_AGG(ce.nick_colaborador, ', ')  WITHIN GROUP (ORDER BY ce.idtipus) AS nick_colaboradors
FROM colaboradors_externs_vinculats cev
INNER JOIN colaboradors_externs ce 
    ON ce.idtipus = cev.colext_id 
   AND ce.idcol_extern = cev.subcolext_id
WHERE 
cev.data_ini <= GETDATE()
  AND (cev.data_fi IS NULL OR cev.data_fi >= GETDATE())
and cev.deleted_at is null 
GROUP BY cev.nif) colaboradors on colaboradors.nif = e.nif 

inner join (select
users.nif,
    STRING_AGG(
        CASE WHEN users.nivell = 4 THEN users.nick_usuari END,
        ', '
    ) WITHIN GROUP (ORDER BY users.nick_usuari) AS user_consultor_ateinsa,
STRING_AGG(
    CASE WHEN users.nivell = 5 THEN users.nick_usuari END,
    ', '
) WITHIN GROUP (ORDER BY users.nick_usuari) AS user_gestor_ateinsa,

STRING_AGG(
    CASE WHEN users.nivell = 7 THEN users.nick_usuari END,
    ', '
) WITHIN GROUP (ORDER BY users.nick_usuari) AS user_admin,

STRING_AGG(
    CASE WHEN users.nivell = 9 THEN users.nick_usuari END,
    ', '
) WITHIN GROUP (ORDER BY users.nick_usuari) AS user_admin_gestores,

STRING_AGG(
    CASE WHEN users.nivell = 14 THEN users.nick_usuari END,
    ', '
) WITHIN GROUP (ORDER BY users.nick_usuari) AS user_promo

from
(

SELECT 
    uwce.nif,
    uw.nivell,
    uw.nick_usuari
FROM usuaris_web_colaboradors_empresa uwce
INNER JOIN usuaris_web uw 
    ON uw.id_usuari = uwce.usuari_id 
 INNER JOIN usuaris_web_tipus uwt ON uw.nivell = uwt.id_tipus_usuari_web 
 inner join colaboradors_externs_vinculats cev on cev.id = uwce.colext_vinc_id and
 cev.deleted_at is null and cev.data_ini <= GETDATE()
  AND (cev.data_fi IS NULL OR cev.data_fi >= GETDATE())
WHERE 
 uwce.deleted_at IS NULL
    AND uwce.data_ini <= GETDATE()
    AND (uwce.data_fi IS NULL OR uwce.data_fi >= GETDATE())
GROUP BY 
    uwce.nif,
     uw.nivell,
    uw.nick_usuari) as users 
    group by users.nif ) as usersnif on usersnif.nif = e.nif 
where user_promo like '%nv%'
