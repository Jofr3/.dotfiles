# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

NixOS and Home Manager flake configuration for a multi-machine setup with Hyprland desktop environment and Stylix theming. Uses nixpkgs unstable channel with unfree packages allowed.

## Common Commands

```bash
# Rebuild NixOS system (personal machine with NVIDIA)
sudo nixos-rebuild switch --flake .#nixos

# Rebuild NixOS system (work machine with Intel graphics)
sudo nixos-rebuild switch --flake .#nixos-lsw

# Update flake inputs
nix flake update

# Format nix files
nixfmt <file.nix>
```

## Architecture

### Directory Structure

```
config/nix/
├── flake.nix              # Flake entrypoint with mkHost helper
├── machines/
│   ├── common.nix         # Shared NixOS base config (boot, audio, networking, theming, etc.)
│   ├── personal/
│   │   ├── hardware.nix   # Auto-generated by nixos-generate-config (NVIDIA, Intel CPU)
│   │   └── graphics.nix   # NVIDIA proprietary driver config
│   └── work/
│       ├── hardware.nix   # Auto-generated (Intel CPU, SOF audio workaround)
│       └── graphics.nix   # Intel modesetting driver config
├── home/
│   ├── default.nix        # Home Manager entry point (user prefs, GTK, MIME, FZF theme)
│   ├── configs.nix        # Dotfile symlinks via mkOutOfStoreSymlink
│   ├── hyprland.nix       # Window manager config (keybindings, monitors, workspaces)
│   ├── packages.nix       # All user packages organized by category
│   └── ssh.nix            # SSH hosts with connection multiplexing
└── theme/
    └── wallpaper.jpg      # Desktop wallpaper
```

### Flake Inputs

Three inputs, all pinned to the same nixpkgs via `inputs.nixpkgs.follows`:
- `nixpkgs` (nixos-unstable)
- `home-manager` (nix-community)
- `stylix` (nix-community)

### Multi-Machine Support

The `mkHost` helper in `flake.nix` creates NixOS configurations. Each host gets a unique `hostId` passed via `specialArgs`/`extraSpecialArgs` to all modules. Home Manager is integrated directly into NixOS modules (not standalone).

Machines share the same hostname but are differentiated by `hostId`:
- `nixos` (personal): `hostId = "9f0dfe7d"` — NVIDIA GPU, dual-monitor
- `nixos-lsw` (work): `hostId = "CHANGEME0"` — Intel GPU, single monitor

Modules use `isPersonal = hostId == "9f0dfe7d"` for host-specific behavior (e.g., monitor layout in hyprland.nix).

### Dotfile Symlink Pattern (configs.nix)

Uses `mkOutOfStoreSymlink` to create symlinks instead of Nix store copies. This allows editing dotfiles without running a rebuild:

```nix
let dotfiles = config.lib.file.mkOutOfStoreSymlink
  "${config.home.homeDirectory}/.dotfiles";
in {
  xdg.configFile = {
    nvim.source = "${dotfiles}/config/nvim";
  };
}
```

To add a new application: add an entry to `xdg.configFile` in `home/configs.nix`.

### Dual Stylix Theming

Stylix must be imported at **both** levels to work correctly:
1. **NixOS level:** `inputs.stylix.nixosModules.stylix` in `machines/common.nix` (system-wide theme)
2. **Home Manager level:** `stylix.enable = true` in `home/default.nix` (user apps theme)

Both use the rose-pine-moon scheme. The NixOS-level `nixpkgs.config` (allowUnfree/allowInsecure) is shared with Home Manager via `useGlobalPkgs = true`.

### Nix Patterns Used

- `lib.mkDefault` in hardware configs for overridable defaults
- `lib.mkForce` in hyprland.nix to override Stylix's default groupbar colors
- `lib.optionals` for conditional workspace assignments (only on dual-monitor)
- `config.home.homeDirectory` for portable path references in modules
- `builtins.concatStringsSep` for readable multi-line string values
